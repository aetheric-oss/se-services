# Interface Control Document (ICD) - Services

<center>

<img src="https://github.com/Arrow-air/tf-github/raw/main/src/templates/doc-banner-services.png" style="height:250px" />

</center>

## :telescope: Overview

This document details the common software interfaces required by all services in the Arrow ecosystem.

Each service may add additional interfaces.

Attribute | Description
--- | ---
Status | Draft

## :books: Related Documents

Document | Description
--- | ---
:construction: Requirements & User Stories :construction: | Requirements and user stories

## :open_file_folder: `Arrow-air/services-api`

Services will communicate with one another.

This document introduces the `Arrow-air/services-api` GitHub repository for storing interface definitions:
- Protocol Buffer Files (`.proto`) for gRPC Interfaces
- OpenAPI3 Specification (OAS) Files (`.json`) for REST Interfaces
- Istio Configuration Files (`.yaml`) for mesh configuration and traffic management
- Autogenerated Rust Code

Individual services will import releases of the `services-api` repository.

```toml
# Service Cargo.toml
[dependencies]
services-api = { git = "https://github.com/Arrow-air/services-api", tag = "v.0.1.1" }
```

Services can import autogenerated code from the dependency.

```rust
//! Scheduler Service

use services_api::svc_storage::*;
```

## :globe_with_meridians: Public API - REST

A Public API is typically consumed by client applications, such as a website or mobile app.

Features of REST:
- Implements common HTTPS Transfer Protocol Methods (GET, PUT, POST, DELETE)
- Respond in JSON, XML, CSV, and other formats
- May autogenerate code from [OpenAPI 3 Specification (OAS)](https://swagger.io/specification/)

### :scroll: Files

File | Description
---- | -----
`common-rest.json` | REST interface definition, in OpenAPI Specification (OAS)
`common-rest.rs` | Code stubs autogenerated from the common_rest.json file.

### :space_invader: Authentication

OAuth2 servers will be used to authorize and authenticate users.

Cloud hosting services offer OAuth2, OpenID, and SAML authorization.

### :mag: Audit Logging

An audit log is a record of all API requests. Each entry of an audit log reports the type of the request along with its result, timestamp and client of origin. Audit logs are important for accountability.

Cloud hosting services (such as AWS Cloud Trail) offer auditing tools for an API.

### :vertical_traffic_light: Rate Limiting

In a Denial of Service (DoS) attack, an attacker issues bursts of API requests in an attempt to exhaust finite server resources. If successful, DoS attacks can occupy disk usage, memory, CPU time, and power - slowing or crashing other server programs. This is of particular concern to the Arrow services, which include safety-critical processes.

Cloud hosting services (such as AWS and GCP) offer rate-limiting features to throttle API requests. AWS and GCP can apply throttles across all accounts and clients in a region, an additional defense against distributed DoS (DDoS) attacks originating from many devices.

### :mailbox_with_mail: Endpoints

| Endpoint | Type | Auth Scope | Description |
| ---- | --- | ---- | ---- |
| `/live` | GET | TODO | Returns a boolean `true` - confirms this service is running

## 🤝 Private API - gRPC

A Private API is typically not exposed to the outside world. Private APIs are commonly used for inter-process communication (IPC) between services on the same device.

[`gRPC`](https://grpc.io/) is a modern, open-source Remote Procedure Call (RPC) framework.

Features of gRPC:
+ Serializes data into Protocol Buffers, strongly typed messages
+ Integrated TLS/SSL authentication and encryption
+ Supports both client and server-side streaming.

Arrow services, which are written in Rust Programming Language, access gRPC features through the [`tonic`](https://docs.rs/tonic/latest/tonic/) library.

### :scroll: Files

File | Description
---- | -----
`common-grpc.proto` | Common gRPC interfaces, protocol buffer file.

### :space_invader: Integrated Authentication & Encryption

gRPC supports Transport Layer Security (TLS): https://grpc.io/docs/guides/auth/

SSL/TLS certificates will be stored as `.pem` file contents in the GitHub organization as [Encrypted Environment Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets). These environment secrets can be accessed by the CI/CD pipeline without exposing the information to the public.

> Privacy Enhanced Mail, or as it is commonly known PEM, is a file format widely used for storing and transferring encrypted data, especially certificates and cryptographic keys

### :sailboat:  Istio

[Istio](https://istio.io/latest/) is software for service monitoring and traffic control.

Arrow Services are run in Docker containers. All traffic to that service first flows through an associated Istio container, which acts as a reverse proxy for the Service. This allows the Istio container to dictate access, monitor and shape traffic, and produce detailed logs.

Istio configuration files are in `.yaml` format. They will be stored in the `services-api` repository alongside `.proto` and OAS files.

### :mailbox_with_no_mail: gRPC Server Methods ("Services")

gRPC server methods are called "services", an unfortunate name clash with the broader concept of web services.

| Service | Description |
| ---- | ---- |
| `IsReady` | Returns a message indicating if this service is ready for requests.<br>Similar to a health check, if a server is not "ready" it could be considered dead by the client making the request.

### :incoming_envelope: gRPC Client Methods ("Requests")

| Request | Description |
| ------    | ------- |
| `RequestReady` | A message to ask any service if it is ready for communication.<br>"Are you alive?"

## :snowflake: ICD Freeze

When the end of a release nears, an "ICD freeze" will occur.

At this point, the following code changes are forbidden (cannot be merged to `develop`):
- Edits to `.proto` files
- Edits to OpenAPI 3 Specification `.json` files
- (Similarly) Any edits to `.rs` files that change request or reply packet formats

When all services produce a new versioned package and the release is declared "complete", the ICD freeze is lifted.

## :ledger: Logs

### :musical_score: Session Event Log (SEL)

An SEL is a record of all events.

It is a JSON file format with the following columns:
- Time (UTC) to the millisecond
- Event Type (String)
- Event Details (JSON)

| Event Type | Description |
| ---- | ---- |
| RIDESHARE/CARGO/CHARTER_CREATE | Create a new flight |
| RIDESHARE/CARGO/CHARTER_CONFIRM | Confirm a flight |
| RIDESHARE/CARGO/CHARTER_MODIFY | Modify a flight |
| RIDESHARE/CARGO/CHARTER_CANCEL | Cancel a flight |
| WEATHER_EVENT | Weather restrictions|
| AIRSPACE_RESTRICT | Airspace Restrictions |
| OPERATOR_DELAY | Operator delay takeoff or landing |
| OPERATOR_EARLY_DEPART_REQ | Pilot/operator request early departure |
| PILOT_ON_DUTY | Pilot signs in to work |
| PILOT_OFF_DUTY | Pilot signs out of work |
| AIRCRAFT_DISABLE | Aircraft is marked as disabled |
| AIRCRAFT_ENABLE | Aircraft is marked as enabled |

### :umbrella: External Event Log (EEL)

An EEL is a record of events originating external to the system. It is a subset of the contents of the Session Event Log (SEL).

Has the same format as the SEL, limited to the following event types:
- CUSTOMER_CREATE
- CUSTOMER_MODIFY
- CUSTOMER_CONFIRM
- CUSTOMER_CANCEL
- WEATHER_EVENT
- AIRSPACE_RESTRICT
- PILOT_ON_DUTY
- PILOT_OFF_DUTY

EEL files can be used to populate the events of the [simulation tool](https://github.com/Arrow-air/tool-simulator) for various purposes, including testing other routing algorithms on a day's events.