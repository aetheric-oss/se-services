# Interface Control Document (ICD) - Services

<center>

<img src="https://github.com/Arrow-air/tf-github/raw/main/src/templates/doc-banner-services.png" style="height:250px" />

</center>

## :telescope: Overview

This document details the common software interfaces required by all services in the Arrow ecosystem.

Each service may add additional interfaces.

Attribute | Description
--- | ---
Status | Draft

## :books: Related Documents

Document | Description
--- | ---
:construction: Requirements & User Stories :construction: | Requirements and user stories
## :globe_with_meridians: Public API - REST

A Public API is typically consumed by client applications, such as a website or mobile app.

Features of REST:
- Implements common HTTPS Transfer Protocol Methods (GET, PUT, POST, DELETE)
- Respond in JSON, XML, CSV, and other formats

### :scroll: Files
A `lib-common` repository will contain REST interfaces that will be used by every microservice.

File | Description
---- | -----
`common-rest.json` | REST interface definition, in OpenAPI Specification (OAS)
`common-rest.rs` | Code stubs autogenerated from the common_rest.json file.

The `lib-common` crate will be published to a registry and added as a dependency by each service, so these interfaces can be incorporated.
```toml
# e.g. svc-scheduler Cargo.toml
[dependencies]
lib-common = 0.1.2
```

Individual services may define further REST endpoints:

```tree
.
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml # [workspace] members = ['client', 'server']
â”œâ”€â”€ Makefile
â”œâ”€â”€ client/
â”œâ”€â”€ proto/
â””â”€â”€ server
    â”œâ”€â”€ build.rs
    â”œâ”€â”€ Cargo.toml
    â”œâ”€â”€ src
    â”‚   â”œâ”€â”€ main.rs
    â”‚   â”œâ”€â”€ public_api.rs # REST Endpoints
```

### :space_invader: Authentication

Login and authentication services are still being decided.

Arrow may leave this to external (non-Arrow) services, such as:
- SSO
- Google/Facebook/Apple Credentials
- Web3 Auth (crypto wallet)

### :mag: Audit Logging

An audit log is a record of all API requests. Each entry of an audit log reports the type of the request along with its result, timestamp and client of origin. Audit logs are important for accountability.

Cloud hosting services (such as AWS Cloud Trail) offer auditing tools for an API.

### :vertical_traffic_light: Rate Limiting

In a Denial of Service (DoS) attack, an attacker issues bursts of API requests in an attempt to exhaust finite server resources. If successful, DoS attacks can occupy disk usage, memory, CPU time, and power - slowing or crashing other server programs. This is of particular concern to the Arrow services, which include safety-critical processes.

Cloud hosting services (such as AWS and GCP) offer rate-limiting features to throttle API requests. AWS and GCP can apply throttles across all accounts and clients in a region, an additional defense against distributed DoS (DDoS) attacks originating from many devices.

### :mailbox_with_mail: Endpoints

| Endpoint | Type | Description |
| ---- | --- |  ---- |
| `/live` | GET | Returns a boolean `true` - confirms this service is running

## ðŸ¤ Private API - gRPC

A Private API is typically not exposed to the outside world. Private APIs are commonly used for inter-process communication (IPC) between services on the same device.

[`gRPC`](https://grpc.io/) is a modern, open-source Remote Procedure Call (RPC) framework.

Features of gRPC:
+ Serializes data into Protocol Buffers, strongly typed messages
+ Integrated TLS/SSL authentication and encryption
+ Supports both client and server-side streaming.

Arrow services, which are written in Rust Programming Language, access gRPC features through the [`tonic`](https://docs.rs/tonic/latest/tonic/) library.

### :scroll: Files

A `lib-common` repository will contain gRPC interfaces that will be used by every microservice.

File | Description
---- | -----
`common-grpc.proto` | Common gRPC interfaces, protocol buffer file.
`common-grpc.rs` | Autogenerated Rust Code

The `lib-common` crate will be published to a registry, and added as a dependency by each service:
```toml
# e.g. svc-scheduler Cargo.toml
[dependencies]
lib-common = 0.1.2
```

Service-specific gRPC files will be defined in each service's repository:
```tree
.
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml # [workspace] members = ['client', 'server']
â”œâ”€â”€ Makefile
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ Cargo.lock
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â””â”€â”€ src
â”‚       â”œâ”€â”€ grpc.rs # autogenerated during `cargo build`
â”‚       â””â”€â”€ lib.rs
â”œâ”€â”€ proto/
â”‚   â””â”€â”€ grpc.proto # used to autogenerate server and client stubs
â””â”€â”€ server
    â”œâ”€â”€ build.rs
    â”œâ”€â”€ Cargo.toml
    â”œâ”€â”€ src
    â”‚   â”œâ”€â”€ grpc.rs # autogenerated during `cargo build`
    â”‚   â”œâ”€â”€ main.rs
```
Details:
- A service codebase shall contain two Rust crates, defined in the directories `server` and `client`.
  - The `server` crate is an executable binary
  - The `client` crate is a library
- There shall be a `proto/` directory containing protocol buffer files.
- During `cargo build`, the protobuf files will be used to autogenerate gRPC server and client stubs.
  - The autogenerated server code is created in the `server/src` directory
  - The autogenerated client code is created in the `client/src` directory.
- Each crate is then compiled
- CI/CD will separately publish these crates to a registry.
  - `svc-scheduler` will publish `svc-scheduler` (server binary) and `svc-scheduler-client` (client library).

A client will access a server's structures and functions by adding a dependency for the target's client crate:
```toml
# svc-pricing (consumer) Cargo.toml 
[dependencies]
svc-scheduler-client = 0.1.0
```
### :space_invader: Integrated Authentication & Encryption

gRPC supports Transport Layer Security (TLS): https://grpc.io/docs/guides/auth/

SSL/TLS certificates will be stored as `.pem` file contents in the GitHub organization as [Encrypted Environment Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets) or in the secrets manager of the cloud provider (AWS, GCP, etc.).

These environment secrets can be accessed by integration tests and CI/CD pipelines without exposing the information to the public.

> Privacy Enhanced Mail, or as it is commonly known PEM, is a file format widely used for storing and transferring encrypted data, especially certificates and cryptographic keys

### :mailbox_with_no_mail: gRPC Server Methods ("Services")

gRPC server methods are called "services", an unfortunate name clash with the broader concept of web services.

| Service | Description |
| ---- | ---- |
| `IsReady` | Returns a message indicating if this service is ready for requests.<br>Similar to a health check, if a server is not "ready" it could be considered dead by the client making the request.

### :incoming_envelope: gRPC Client Methods ("Requests")

| Request | Description |
| ------    | ------- |
| `RequestReady` | A message to ask any service if it is ready for communication.<br>"Are you alive?"

### :sailboat:  Istio

[Istio](https://istio.io/latest/) is software for service monitoring and traffic control.

Arrow Services are run in Docker containers. All traffic to that service first flows through an associated Istio container, which acts as a reverse proxy for the Service. This allows the Istio container to dictate access, monitor and shape traffic, and produce detailed logs.

Istio configuration files are in `.yaml` format. Each service's repository will track an Istio file.

## :snowflake: ICD Freeze

When the end of a release nears, an "ICD freeze" will occur.

At this point, the following code changes are forbidden (cannot be merged to `develop`):
- Edits to `.proto` files
- Edits to OpenAPI 3 Specification `.json` files
- (Similarly) Any edits to `.rs` files that change request or reply packet formats

When all services produce a new versioned package and the release is declared "complete", the ICD freeze is lifted.
