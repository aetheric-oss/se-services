# Interface Control Document (ICD) - Services

<center>

<img src="https://github.com/Arrow-air/tf-github/raw/main/src/templates/doc-banner-services.png" style="height:250px" />

</center>

## :telescope: Overview

This document details the common software interfaces required by all services in the Arrow ecosystem.

Each service may add additional interfaces.

Attribute | Description
--- | ---
Status | Draft

## :books: Related Documents

Document | Description
--- | ---
:construction: Requirements & User Stories :construction: | Requirements and user stories

## :globe_with_meridians: Public API - REST

A Public API is typically consumed by client applications, such as a website or mobile app.

Features of REST:
- Implements common HTTPS Transfer Protocol Methods (GET, PUT, POST, DELETE)
- Respond in JSON, XML, CSV, and other formats
- May autogenerate code from [OpenAPI 3 Specification (OAS)](https://swagger.io/specification/)

### :scroll: Files

File | Description
---- | -----
`common-rest.json` | REST interface definition, in OpenAPI Specification (OAS)
`common-rest.rs` | Code stubs autogenerated from the common_rest.json file. 
### :space_invader: Authentication

Arrow will run OAuth2 server(s)...? 

### :mailbox_with_mail: Endpoints

| Endpoint | Type | Auth Scope | Description |
| ---- | --- | ---- | ---- |
| `/live` | GET | TODO | Returns a boolean `true` - confirms this service is running
| `/container/status` | GET | TODO | Version<br>Uptime<br>Memory (Use, Limit)<br>I/O (Use, Limit)<br>Obtains this info from Docker Unix socket via the [`rs-docker`](https://crates.io/crates/rs-docker) library<sup>*</sup>


<sup>*</sup>May obtain this information via command line using `docker` commands:

```bash
$ docker stats
CONTAINER ID        CPU %               PRIV WORKING SET    NET I/O             BLOCK I/O
09d3bb5b1604        6.61%               38.21 MiB           17.1 kB / 7.73 kB   10.7 MB / 3.57 MB

$ docker stats --all --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
CONTAINER           CPU %               MEM USAGE / LIMIT
svc-scheduler-v1    6.61%               20KiB / 16GiB

$ docker ps -a
CONTAINER ID        NAME                IMAGE             CREATED             STATUS
09d3bb5b1604        svc-scheduler       v1.23             2 minutes ago       Up 2 minutes
```

## 🤝 Private API - gRPC

A Private API is typically not exposed to the outside world. Private APIs are commonly used for inter-process communication (IPC) between services on the same device.

[`gRPC`](https://grpc.io/) is a modern, open-source Remote Procedure Call (RPC) framework.

Features of gRPC:
+ Serializes data into Protocol Buffers, strongly typed messages
+ Integrated TLS/SSL authentication and encryption
+ Supports both client and server-side streaming.

Arrow services, which are written in Rust Programming Language, access gRPC features through the [`tonic`](https://docs.rs/tonic/latest/tonic/) library.

### :scroll: Files

File | Description
---- | -----
`common-grpc.proto` | Common gRPC interfaces, protocol buffer file.

### :space_invader: Integrated Authentication & Encryption

gRPC supports Transport Layer Security (TLS): https://grpc.io/docs/guides/auth/

SSL/TLS certificates will be stored as `.pem` file contents in the GitHub organization as [Encrypted Environment Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets). These environment secrets can be accessed by the CI/CD pipeline without exposing the information to the public.

> Privacy Enhanced Mail, or as it is commonly known PEM, is a file format widely used for storing and transferring encrypted data, especially certificates and cryptographic keys

### :mailbox_with_no_mail: gRPC Server Methods ("Services")

gRPC server methods are called "services", an unfortunate name clash with the broader concept of web services.

| Service | Description |
| ---- | ---- |
| `IsReady` | Returns a message indicating if this service is ready for requests.<br>Similar to a health check, if a server is not "ready" it could be considered dead by the client making the request.

### :incoming_envelope: gRPC Client Methods ("Requests")

| Request | Description |
| ------    | ------- |
| `RequestReady` | A message to ask any service if it is ready for communication.<br>"Are you alive?"

## :open_file_folder: API File Locations

The `common-grpc.proto` and `common-rest.json` files (along with any autogenerated code stub files) will exist in the codebase of each Arrow service. These files should not be edited or moved, as it could put a service out of sync with another service's "common" interface.

The source truth of these files will instead be tracked by the [`tf-github`](https://github.com/Arrow-air/tf-github) repository. Changes to these files will be reviewed in a tf-github repository pull request. [Terraform](https://www.terraform.io/), an infrastructure-as-code tool, will push changes to the `develop` branch of all Arrow services simultaneously, keeping all services in sync.

## :snowflake: ICD Freeze

When the end of a release nears, an "ICD freeze" will occur.

At this point, the following code changes are forbidden (cannot be merged to `develop`):
- Edits to `.proto` files
- Edits to OpenAPI 3 Specification `.json` files
- (Similarly) Any edits to `.rs` files that change request or reply packet formats

This includes these files in the `tf-github` repository.

When all services produce a new versioned package and the release is declared "complete", the ICD freeze is lifted.

## :ledger: Logs

### :musical_score: Session Event Log (SEL)

An SEL is a record of all events.

It is a CSV file format with the following columns:
- Time (UTC) to the millisecond
- Event Type (String)
- Event Details (JSON)

| Event Type | Description |
| ---- | ---- |
| RIDESHARE/CARGO/CHARTER_CREATE | Create a new flight |
| RIDESHARE/CARGO/CHARTER_CONFIRM | Confirm a flight |
| RIDESHARE/CARGO/CHARTER_MODIFY | Modify a flight |
| RIDESHARE/CARGO/CHARTER_CANCEL | Cancel a flight |
| WEATHER_EVENT | Weather restrictions|
| AIRSPACE_RESTRICT | Airspace Restrictions |
| OPERATOR_DELAY | Operator delay takeoff or landing |
| OPERATOR_EARLY_DEPART_REQ | Pilot/operator request early departure |
| PILOT_ON_DUTY | Pilot signs in to work |
| PILOT_OFF_DUTY | Pilot signs out of work |
| AIRCRAFT_DISABLE | Aircraft is marked as disabled |
| AIRCRAFT_ENABLE | Aircraft is marked as enabled |

### :umbrella: External Event Log (EEL)

An EEL is a record of events originating external to the system. It is a subset of the contents of the Session Event Log (SEL).

Has the same format as the SEL, limited to the following event types:
- CUSTOMER_CREATE
- CUSTOMER_MODIFY
- CUSTOMER_CONFIRM
- CUSTOMER_CANCEL
- WEATHER_EVENT
- AIRSPACE_RESTRICT
- PILOT_ON_DUTY
- PILOT_OFF_DUTY

EEL files can be used to populate the events of the [simulation tool](https://github.com/Arrow-air/tool-simulator) for various purposes, including testing other routing algorithms on a day's events.